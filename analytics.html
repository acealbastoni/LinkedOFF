<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„Ø³ÙˆÙ‚ - LinkedOFF</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/styles.css">
  <link rel="stylesheet" href="css/enhancements.css">
  <link rel="stylesheet" href="css/responsive.css">
  <link rel="icon" type="image/svg+xml" href="img/icon-linkedoff.svg">

  <!-- â•â•â• EARLY AUTH GUARD â•â•â• -->
  <style>body { visibility: hidden; }</style>
  <script>
    (function () {
      try {
        var user = JSON.parse(localStorage.getItem('linkedoff_user') || 'null');
        var sess = JSON.parse(localStorage.getItem('linkedoff_session') || 'null');
        if (!user || !sess || !sess.token || Date.now() > Number(sess.expiresAtMs || 0)) {
          window.location.replace('login.html');
        } else {
          document.addEventListener('DOMContentLoaded', function () {
            document.body.style.visibility = 'visible';
          });
        }
      } catch (e) { window.location.replace('login.html'); }
    })();
  </script>
  <script src="js/auth.js"></script>
  <script src="js/config.js"></script>
  <script>startSessionEnforcer();</script>

  <style>
    /* â”€â”€ Analytics Page â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .an-wrapper { max-width: 1100px; margin: 0 auto; padding-bottom: 60px; }

    /* Hero launch card */
    .an-launch {
      background: linear-gradient(135deg, #0d1f15 0%, #0a1628 100%);
      border: 1px solid rgba(29,191,115,.2);
      border-radius: 20px;
      padding: 40px 36px;
      text-align: center;
      margin-bottom: 28px;
      position: relative;
      overflow: hidden;
    }

    .an-launch::before {
      content: '';
      position: absolute;
      top: -60px; right: -60px;
      width: 220px; height: 220px;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(29,191,115,.15), transparent 70%);
      pointer-events: none;
    }

    .an-launch h1 {
      font-size: 1.9rem;
      font-weight: 900;
      background: linear-gradient(90deg, #1dbf73, #60c8ff);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 10px;
    }

    .an-launch p { color: #8899aa; font-size: 0.95rem; margin-bottom: 28px; }

    .an-pages-control {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 14px;
      margin-bottom: 22px;
      flex-wrap: wrap;
    }

    .an-pages-control label {
      color: #aaa;
      font-size: 0.88rem;
      font-weight: 700;
      font-family: 'Cairo', sans-serif;
    }

    .an-pages-control select {
      background: rgba(255,255,255,.07);
      border: 1px solid rgba(255,255,255,.15);
      color: #f0f0f0;
      border-radius: 10px;
      padding: 8px 14px;
      font-family: 'Cairo', sans-serif;
      font-size: 0.9rem;
      cursor: pointer;
    }

    .an-start-btn {
      background: linear-gradient(135deg, #1dbf73, #00D66F);
      color: #fff;
      border: none;
      border-radius: 14px;
      padding: 14px 40px;
      font-family: 'Cairo', sans-serif;
      font-size: 1rem;
      font-weight: 900;
      cursor: pointer;
      box-shadow: 0 4px 20px rgba(29,191,115,.35);
      transition: transform .15s, box-shadow .15s;
      letter-spacing: .3px;
    }

    .an-start-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 28px rgba(29,191,115,.45); }
    .an-start-btn:disabled { opacity: .5; cursor: not-allowed; transform: none; }

    /* Progress */
    .an-progress-wrap {
      display: none;
      margin-top: 20px;
    }

    .an-progress-wrap.show { display: block; }

    .an-progress-label {
      font-size: 0.85rem;
      color: #8899aa;
      margin-bottom: 8px;
      font-family: 'Cairo', sans-serif;
    }

    .an-progress-bar-bg {
      background: rgba(255,255,255,.08);
      border-radius: 8px;
      height: 8px;
      overflow: hidden;
    }

    .an-progress-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, #1dbf73, #00D66F);
      border-radius: 8px;
      width: 0%;
      transition: width .4s ease;
    }

    /* Stats row */
    .an-stats-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .an-stat-card {
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 16px;
      padding: 20px;
      text-align: center;
      animation: _cardIn .35s ease both;
    }

    .an-stat-card .an-stat-num {
      font-size: 2rem;
      font-weight: 900;
      color: #1dbf73;
      line-height: 1;
      margin-bottom: 6px;
    }

    .an-stat-card .an-stat-label {
      font-size: 0.82rem;
      color: #8899aa;
      font-family: 'Cairo', sans-serif;
    }

    /* Section cards */
    .an-section {
      background: rgba(255,255,255,.03);
      border: 1px solid rgba(255,255,255,.07);
      border-radius: 18px;
      padding: 24px 26px;
      margin-bottom: 20px;
      animation: _cardIn .35s ease both;
    }

    .an-section-title {
      font-size: 1rem;
      font-weight: 900;
      color: #f0f0f0;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
      padding-bottom: 12px;
      border-bottom: 1px solid rgba(255,255,255,.07);
    }

    .an-section-title .badge {
      font-size: 0.72rem;
      background: rgba(29,191,115,.15);
      color: #1dbf73;
      border: 1px solid rgba(29,191,115,.25);
      padding: 2px 10px;
      border-radius: 10px;
      font-weight: 700;
    }

    /* Bar chart rows */
    .an-bar-list { display: flex; flex-direction: column; gap: 10px; }

    .an-bar-item {
      display: grid;
      grid-template-columns: 160px 1fr 50px;
      align-items: center;
      gap: 12px;
      font-size: 0.85rem;
    }

    .an-bar-item .an-bar-label {
      color: #c0ccd8;
      font-family: 'Cairo', sans-serif;
      font-weight: 700;
      text-align: right;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      direction: ltr;
      text-align: left;
    }

    .an-bar-item .an-bar-label.rtl { direction: rtl; text-align: right; }

    .an-bar-track {
      background: rgba(255,255,255,.06);
      border-radius: 6px;
      height: 10px;
      overflow: hidden;
    }

    .an-bar-fill {
      height: 100%;
      border-radius: 6px;
      transition: width .8s cubic-bezier(.23,1,.32,1);
    }

    .an-bar-fill.green  { background: linear-gradient(90deg, #1dbf73, #00D66F); }
    .an-bar-fill.blue   { background: linear-gradient(90deg, #3b82f6, #60c8ff); }
    .an-bar-fill.orange { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
    .an-bar-fill.purple { background: linear-gradient(90deg, #8b5cf6, #a78bfa); }
    .an-bar-fill.red    { background: linear-gradient(90deg, #ef4444, #f87171); }
    .an-bar-fill.teal   { background: linear-gradient(90deg, #14b8a6, #2dd4bf); }

    .an-bar-item .an-bar-count {
      color: #8899aa;
      font-size: 0.8rem;
      font-weight: 700;
      text-align: left;
    }

    /* Tag cloud */
    .an-tag-cloud {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 4px;
    }

    .an-tag {
      padding: 5px 14px;
      border-radius: 20px;
      font-size: 0.82rem;
      font-weight: 700;
      font-family: 'Cairo', sans-serif;
      cursor: default;
      transition: transform .15s;
      direction: ltr;
    }

    .an-tag:hover { transform: translateY(-2px); }

    .an-tag.size-1 { font-size: 0.75rem; background: rgba(29,191,115,.1); color: #1dbf73; border: 1px solid rgba(29,191,115,.2); }
    .an-tag.size-2 { font-size: 0.85rem; background: rgba(29,191,115,.15); color: #1dbf73; border: 1px solid rgba(29,191,115,.25); }
    .an-tag.size-3 { font-size: 0.95rem; background: rgba(29,191,115,.22); color: #1dbf73; border: 1px solid rgba(29,191,115,.35); }
    .an-tag.size-4 { font-size: 1.05rem; background: rgba(29,191,115,.3); color: #1dbf73; border: 1px solid rgba(29,191,115,.45); font-weight: 900; }
    .an-tag.size-5 { font-size: 1.15rem; background: rgba(29,191,115,.38); color: #fff; border: 1px solid rgba(29,191,115,.55); font-weight: 900; box-shadow: 0 2px 10px rgba(29,191,115,.2); }

    /* Donut rings (pure CSS) */
    .an-donut-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 16px;
      margin-top: 4px;
    }

    .an-donut-item {
      text-align: center;
    }

    .an-donut-ring {
      width: 72px; height: 72px;
      border-radius: 50%;
      margin: 0 auto 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9rem;
      font-weight: 900;
      color: #f0f0f0;
      position: relative;
    }

    .an-donut-label { font-size: 0.78rem; color: #aaa; font-family: 'Cairo', sans-serif; }
    .an-donut-sub   { font-size: 0.72rem; color: #666; margin-top: 2px; }

    /* Empty state */
    .an-empty {
      text-align: center;
      padding: 60px 20px;
      color: #8899aa;
    }

    .an-empty .icon { font-size: 3rem; margin-bottom: 12px; }
    .an-empty p { font-size: 0.92rem; }

    /* Grid 2 cols */
    .an-grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    @media (max-width: 700px) {
      .an-grid-2 { grid-template-columns: 1fr; }
      .an-bar-item { grid-template-columns: 120px 1fr 40px; }
      .an-launch h1 { font-size: 1.4rem; }
    }

    /* â”€â”€ Analytics is dark-themed â€” force dark content bg always â”€â”€ */
    .app-content {
      background: #080e18 !important;
      color: #d0d8e8;
    }

    /* â”€â”€ Dark mode: deepen even further â”€â”€ */
    body.dark-mode .app-content { background: #050a12 !important; }
    body.dark-mode .an-launch   { border-color: rgba(29,191,115,.15) !important; }
    body.dark-mode .an-section  { background: rgba(255,255,255,.02) !important; border-color: rgba(255,255,255,.05) !important; }
    body.dark-mode .an-stat-card { background: rgba(255,255,255,.025) !important; border-color: rgba(255,255,255,.05) !important; }
    body.dark-mode .an-pages-control select { background: rgba(0,0,0,.4) !important; }
  </style>
</head>

<body class="app-page" data-page="analytics">
<div class="app-shell">
  <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar(false)"></div>

  <!-- â”€â”€â”€ Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <aside class="app-sidebar" id="appSidebar" aria-label="Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©">
    <div class="sidebar-brand">
      <a href="search.html" class="brand-link">
        <span class="brand-mark">ğŸ’¼</span>
        <span class="brand-text">LinkedOFF</span>
        <span class="brand-sub">AceAlBastoni</span>
      </a>
    </div>

    <nav class="sidebar-nav">
      <a href="search.html"              class="nav-item"><span class="nav-ic">ğŸ </span><span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span></a>
      <a href="search.html"              class="nav-item"><span class="nav-ic">ğŸ”</span><span>Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙˆØ¸Ø§Ø¦Ù</span></a>
      <a href="dashboard.html"           class="nav-item"><span class="nav-ic">ğŸ“Š</span><span>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</span></a>
      <a href="analytics.html"           class="nav-item active"><span class="nav-ic">ğŸ“ˆ</span><span>ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„Ø³ÙˆÙ‚</span></a>
      <a href="saved.html"               class="nav-item"><span class="nav-ic">ğŸ’¾</span><span>Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©</span></a>
      <a href="history.html"             class="nav-item"><span class="nav-ic">ğŸ“¬</span><span>Ø³Ø¬Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</span></a>
      <a href="engines-interactive.html" class="nav-item"><span class="nav-ic">âš™ï¸</span><span>Ø§Ù„Ù…Ø­Ø±ÙƒØ§Øª</span></a>
      <a href="about.html"               class="nav-item"><span class="nav-ic">ğŸ‘¤</span><span>Ø¹Ù† Ø§Ù„Ù…Ø·ÙˆÙ‘Ø±</span></a>
      <a href="pricing.html"             class="nav-item"><span class="nav-ic">ğŸ’³</span><span>Ø§Ù„Ø¨Ø§Ù‚Ø§Øª</span></a>
      <a href="settings.html"            class="nav-item"><span class="nav-ic">ğŸ”§</span><span>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span></a>
    </nav>

    <div class="sidebar-footer">
      <button class="sidebar-logout" type="button" onclick="performLogout('ğŸ‘‹ ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬', false)">
        <span class="nav-ic">ğŸšª</span><span>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</span>
      </button>
    </div>
  </aside>

  <!-- â”€â”€â”€ Main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="app-main">
    <header class="app-topbar">
      <button class="sidebar-toggle" type="button" aria-label="ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©" onclick="toggleSidebar()">
        <span class="toggle-bars"></span>
      </button>
      <div class="topbar-title">ğŸ“ˆ ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„Ø³ÙˆÙ‚</div>
      <div class="topbar-actions">
        <button id="darkModeBtn" onclick="toggleDarkMode()" title="ÙˆØ¶Ø¹ Ù„ÙŠÙ„ÙŠ" style="
          background:none;border:1px solid rgba(255,255,255,.15);border-radius:8px;
          padding:6px 10px;cursor:pointer;font-size:18px;line-height:1;
          transition:background .2s,border-color .2s;
        ">ğŸŒ™</button>
      </div>
    </header>

    <main class="app-content">
      <div class="an-wrapper">

        <!-- Launch Card -->
        <div class="an-launch">
          <h1>ğŸ”¬ ØªØ­Ù„ÙŠÙ„ Ø°ÙƒÙŠ Ù„Ø³ÙˆÙ‚ Ø§Ù„Ø¹Ù…Ù„</h1>
          <p>ÙŠØ¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØ¸Ø§Ø¦Ù ÙˆÙŠØ­Ù„Ù„Ù‡Ø§ Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ insights Ø­Ù‚ÙŠÙ‚ÙŠØ© Ø¹Ù† Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠ</p>

          <div class="an-pages-control">
            <label>Ø¹Ø¯Ø¯ Ø§Ù„ØµÙØ­Ø§Øª Ù„Ù„ØªØ­Ù„ÙŠÙ„:</label>
            <select id="pagesToAnalyze">
              <option value="5">5 ØµÙØ­Ø§Øª (~250 ÙˆØ¸ÙŠÙØ©) â€” Ø³Ø±ÙŠØ¹</option>
              <option value="10" selected>10 ØµÙØ­Ø§Øª (~500 ÙˆØ¸ÙŠÙØ©)</option>
              <option value="20">20 ØµÙØ­Ø© (~1,000 ÙˆØ¸ÙŠÙØ©)</option>
              <option value="50">50 ØµÙØ­Ø© (~2,500 ÙˆØ¸ÙŠÙØ©) â€” Ø´Ø§Ù…Ù„</option>
            </select>
          </div>

          <button class="an-start-btn" id="startAnalysisBtn" onclick="startAnalysis()">
            ğŸš€ Ø§Ø¨Ø¯Ø£ Ø§Ù„ØªØ­Ù„ÙŠÙ„
          </button>

          <div class="an-progress-wrap" id="progressWrap">
            <div class="an-progress-label" id="progressLabel">Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>
            <div class="an-progress-bar-bg">
              <div class="an-progress-bar-fill" id="progressFill"></div>
            </div>
          </div>
        </div>

        <!-- Results â€” hidden until analysis runs -->
        <div id="analysisResults" style="display:none;">

          <!-- Overview stats -->
          <div class="an-stats-row" id="statsRow"></div>

          <!-- Hashtags -->
          <div class="an-section">
            <div class="an-section-title">
              # Ø£ÙƒØ«Ø± Ø§Ù„Ù€ Hashtags Ø°ÙƒØ±Ø§Ù‹
              <span class="badge">Ø³Ø­Ø§Ø¨Ø© Ø§Ù„ÙƒÙ„Ù…Ø§Øª</span>
            </div>
            <div class="an-tag-cloud" id="hashtagCloud"></div>
          </div>

          <div class="an-grid-2">
            <!-- Email Domains -->
            <div class="an-section">
              <div class="an-section-title">ğŸ“§ Ø£ÙƒØ«Ø± Ù†Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¨Ø±ÙŠØ¯ (Recruiters)</div>
              <div class="an-bar-list" id="domainBars"></div>
            </div>

            <!-- Cities -->
            <div class="an-section">
              <div class="an-section-title">ğŸ“ Ø£ÙƒØ«Ø± Ø§Ù„Ù…Ø¯Ù† Ø§Ù„Ù…Ø°ÙƒÙˆØ±Ø©</div>
              <div class="an-bar-list" id="cityBars"></div>
            </div>
          </div>

          <div class="an-grid-2">
            <!-- Tech Skills -->
            <div class="an-section">
              <div class="an-section-title">ğŸ› ï¸ Ø£ÙƒØ«Ø± Ø§Ù„Ù…Ù‡Ø§Ø±Ø§Øª Ø§Ù„ØªÙ‚Ù†ÙŠØ© Ø·Ù„Ø¨Ø§Ù‹</div>
              <div class="an-bar-list" id="skillBars"></div>
            </div>

            <!-- Contract types -->
            <div class="an-section">
              <div class="an-section-title">ğŸ“… Ø£Ù†ÙˆØ§Ø¹ Ø¹Ù‚ÙˆØ¯ Ø§Ù„Ø¹Ù…Ù„</div>
              <div class="an-bar-list" id="contractBars"></div>
            </div>
          </div>

          <!-- Arabic keywords -->
          <div class="an-section">
            <div class="an-section-title">ğŸ”‘ Ø£ÙƒØ«Ø± Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ØªÙƒØ±Ø§Ø±Ø§Ù‹ ÙÙŠ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª</div>
            <div class="an-bar-list" id="arabicKeyBars"></div>
          </div>

          <!-- Language distribution -->
          <div class="an-section">
            <div class="an-section-title">ğŸŒ ØªÙˆØ²ÙŠØ¹ Ù„ØºØ© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©</div>
            <div class="an-donut-grid" id="donutGrid"></div>
          </div>

        </div><!-- /analysisResults -->

      </div>
    </main>
  </div>
</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Analytics Engine
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

const CITIES = [
  'Ø§Ù„Ø±ÙŠØ§Ø¶','Ø¬Ø¯Ø©','Ø§Ù„Ø¯Ù…Ø§Ù…','Ù…ÙƒØ©','Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©','Ø§Ù„Ø®Ø¨Ø±','Ø§Ù„Ø·Ø§Ø¦Ù','ØªØ¨ÙˆÙƒ',
  'Ø£Ø¨Ù‡Ø§','Ø­Ø§Ø¦Ù„','Ø¨Ø±ÙŠØ¯Ø©','Ù†Ø¬Ø±Ø§Ù†','Ø§Ù„Ù‚ØµÙŠÙ…','Ø§Ù„Ø¬ÙˆÙ','ÙŠÙ†Ø¨Ø¹','Ø¬Ø§Ø²Ø§Ù†',
  'Ø§Ù„Ø£Ø­Ø³Ø§Ø¡','Ø§Ù„Ù‚Ø·ÙŠÙ','Ø­ÙØ± Ø§Ù„Ø¨Ø§Ø·Ù†','Ø³ÙƒØ§ÙƒØ§','Dubai','Riyadh','Jeddah','Dammam'
];

const SKILLS = [
  'Python','JavaScript','Java','SQL','PHP','React','Node','Angular',
  'Excel','Power BI','AWS','Azure','Docker','Linux','Git','SAP',
  'AutoCAD','Revit','PMP','IELTS','MBA','CPA','CMA','HR','ERP',
  'SEO','Marketing','Salesforce','Tableau','Kotlin','Swift','Flutter',
  'TypeScript','MongoDB','MySQL','Oracle','C#','.NET','Spring','Django'
];

const ARABIC_KEYS = [
  'Ø®Ø¨Ø±Ø©','Ø³Ù†ÙˆØ§Øª','Ù…Ø¨ÙŠØ¹Ø§Øª','ØªØ³ÙˆÙŠÙ‚','Ù‡Ù†Ø¯Ø³Ø©','Ù…Ø­Ø§Ø³Ø¨Ø©','Ø¥Ø¯Ø§Ø±Ø©','Ù…ÙˆØ§Ø±Ø¯',
  'ØªÙ‚Ù†ÙŠØ©','Ø¨Ø±Ù…Ø¬Ø©','ØªØµÙ…ÙŠÙ…','ØµØ­Ø©','ØªØ¹Ù„ÙŠÙ…','Ù…Ø§Ù„ÙŠØ©','Ù…Ø´ØªØ±ÙŠØ§Øª','Ù„ÙˆØ¬Ø³ØªÙŠÙƒ',
  'Ø¹Ù‚Ø§Ø±Ø§Øª','Ø¨Ù†Ø§Ø¡','Ø£Ù…Ù†','Ø´Ø¨ÙƒØ§Øª','Ø¨ÙŠØ§Ù†Ø§Øª','Ø°ÙƒØ§Ø¡','ØªØ­Ù„ÙŠÙ„','Ù‚Ø§Ù†ÙˆÙ†',
  'Ø¹Ù„Ø§Ù‚Ø§Øª','Ø®Ø¯Ù…Ø©','Ø¹Ù…Ù„Ø§Ø¡','Ù…Ø´Ø±ÙˆØ¹','ØªØ·ÙˆÙŠØ±','Ø¬ÙˆØ¯Ø©','Ø¹Ù…Ù„ÙŠØ§Øª'
];

const CONTRACT_TYPES = [
  { label: 'Ø¯ÙˆØ§Ù… ÙƒØ§Ù…Ù„', keys: ['Ø¯ÙˆØ§Ù… ÙƒØ§Ù…Ù„','full time','full-time'] },
  { label: 'Ø¹Ù† Ø¨Ø¹Ø¯',    keys: ['Ø¹Ù† Ø¨Ø¹Ø¯','remote','work from home'] },
  { label: 'Ø¯ÙˆØ§Ù… Ø¬Ø²Ø¦ÙŠ', keys: ['Ø¯ÙˆØ§Ù… Ø¬Ø²Ø¦ÙŠ','part time','part-time'] },
  { label: 'Ù…Ø¤Ù‚Øª',      keys: ['Ù…Ø¤Ù‚Øª','temporary','contract'] },
  { label: 'ØªØ¯Ø±ÙŠØ¨',     keys: ['ØªØ¯Ø±ÙŠØ¨','intern','internship'] }
];

let _analysisAbort = false;

async function fetchPage(page) {
  const user = getCurrentUser();
  const sess = getCurrentSession();
  if (!user || !sess) throw new Error('Session missing');

  const url =
    `${API_CONFIG.baseURL}?key=${encodeURIComponent(API_CONFIG.apiKey)}` +
    `&email=${encodeURIComponent(user.email)}` +
    `&sessionToken=${encodeURIComponent(sess.token)}` +
    `&page=${encodeURIComponent(page)}` +
    `&pageSize=50`;

  const res  = await fetch(url, { method: 'GET', redirect: 'follow' });
  const text = await res.text();
  const data = JSON.parse(text);
  if (data.code === 'session_expired' || data.code === 'invalid_session') {
    performLogout('â³ Ø§Ù†ØªÙ‡Øª Ø§Ù„Ø¬Ù„Ø³Ø©.', true);
    throw new Error('Session expired');
  }
  if (!data.ok) throw new Error(data.message || 'Error');
  return data;
}

function countTop(map, n = 10) {
  return Object.entries(map)
    .sort((a, b) => b[1] - a[1])
    .slice(0, n);
}

function escHtml(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

async function startAnalysis() {
  _analysisAbort = false;
  const btn = document.getElementById('startAnalysisBtn');
  const maxPages = parseInt(document.getElementById('pagesToAnalyze').value) || 10;
  btn.disabled = true;
  btn.textContent = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„...';

  document.getElementById('analysisResults').style.display = 'none';
  document.getElementById('progressWrap').classList.add('show');

  // Data buckets
  const hashtags   = {};
  const domains    = {};
  const cities     = {};
  const skills     = {};
  const arabicKeys = {};
  const contracts  = {};
  CITIES.forEach(c => cities[c] = 0);
  SKILLS.forEach(s => skills[s] = 0);
  ARABIC_KEYS.forEach(k => arabicKeys[k] = 0);
  CONTRACT_TYPES.forEach(ct => contracts[ct.label] = 0);

  let totalJobs  = 0;
  let withSalary = 0;
  let withRemote = 0;
  let enJobs     = 0;
  let arJobs     = 0;
  let realPages  = 0;

  for (let p = 1; p <= maxPages; p++) {
    if (_analysisAbort) break;

    // update progress
    const pct = Math.round((p - 1) / maxPages * 100);
    document.getElementById('progressFill').style.width = pct + '%';
    document.getElementById('progressLabel').textContent =
      `Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© ${p} Ù…Ù† ${maxPages}... (${totalJobs} ÙˆØ¸ÙŠÙØ© Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†)`;

    try {
      const data = await fetchPage(p);
      const jobs = data.data || [];
      realPages = data.totalPages || maxPages;

      jobs.forEach(job => {
        const desc = (job.plainTextJobDescription || '').toLowerCase();
        const raw  = (job.plainTextJobDescription || '');
        const src  = (job.source || '');
        totalJobs++;

        // Language detection
        const arChars = (raw.match(/[\u0600-\u06FF]/g) || []).length;
        const enChars = (raw.match(/[a-zA-Z]/g) || []).length;
        if (arChars > enChars) arJobs++; else enJobs++;

        // Hashtags
        const tags = raw.match(/#[\u0600-\u06FFa-zA-Z0-9_]+/g) || [];
        tags.forEach(t => { hashtags[t] = (hashtags[t] || 0) + 1; });

        // Email domain
        const dm = src.match(/@([a-zA-Z0-9.-]+\.[a-zA-Z]{2,})/);
        if (dm) { const d = dm[1].toLowerCase(); domains[d] = (domains[d] || 0) + 1; }

        // Cities
        CITIES.forEach(c => { if (desc.includes(c.toLowerCase())) cities[c]++; });

        // Skills
        SKILLS.forEach(s => { if (desc.includes(s.toLowerCase())) skills[s]++; });

        // Arabic keywords
        ARABIC_KEYS.forEach(k => { if (desc.includes(k)) arabicKeys[k]++; });

        // Contract types
        CONTRACT_TYPES.forEach(ct => {
          if (ct.keys.some(k => desc.includes(k))) contracts[ct.label]++;
        });

        // Salary mention
        if (/\d{3,}.*?(Ø±ÙŠØ§Ù„|sar|sr)/i.test(raw)) withSalary++;

        // Remote
        if (/(Ø¹Ù† Ø¨Ø¹Ø¯|remote|work from home)/i.test(raw)) withRemote++;
      });

      if (p >= realPages) break; // no more pages
    } catch (err) {
      if (err.message === 'Session expired') return;
      console.warn('Page', p, 'failed:', err.message);
    }

    await new Promise(r => setTimeout(r, 150));
  }

  document.getElementById('progressFill').style.width = '100%';
  document.getElementById('progressLabel').textContent = `âœ… Ø§ÙƒØªÙ…Ù„ Ø§Ù„ØªØ­Ù„ÙŠÙ„ â€” ${totalJobs} ÙˆØ¸ÙŠÙØ©`;

  renderResults({
    totalJobs, withSalary, withRemote, enJobs, arJobs,
    hashtags, domains, cities, skills, arabicKeys, contracts, realPages
  });

  btn.disabled = false;
  btn.textContent = 'ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„';
}

function renderResults(d) {
  document.getElementById('analysisResults').style.display = 'block';

  /* â”€â”€ Overview stats â”€â”€ */
  document.getElementById('statsRow').innerHTML = [
    { num: d.totalJobs.toLocaleString('ar'), label: 'ÙˆØ¸ÙŠÙØ© ØªÙ… ØªØ­Ù„ÙŠÙ„Ù‡Ø§' },
    { num: Math.round(d.withSalary / d.totalJobs * 100) + '%', label: 'ÙˆØ¸Ø§Ø¦Ù ØªØ°ÙƒØ± Ø§Ù„Ø±Ø§ØªØ¨' },
    { num: Math.round(d.withRemote / d.totalJobs * 100) + '%', label: 'ÙˆØ¸Ø§Ø¦Ù Ø¹Ù† Ø¨Ø¹Ø¯ Ø£Ùˆ Ù‡Ø¬ÙŠÙ†Ø©' },
    { num: Object.keys(d.domains).length, label: 'Ø´Ø±ÙƒØ©/Ù…Ø¬Ù†Ù‘Ø¯ Ù…Ø®ØªÙ„Ù' },
    { num: Object.keys(d.hashtags).length, label: 'Ù‡Ø§Ø´ØªØ§Ù‚ ÙØ±ÙŠØ¯' },
    { num: d.realPages.toLocaleString('ar'), label: 'ØµÙØ­Ø© ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª' }
  ].map(s => `
    <div class="an-stat-card">
      <div class="an-stat-num">${escHtml(s.num)}</div>
      <div class="an-stat-label">${escHtml(s.label)}</div>
    </div>
  `).join('');

  /* â”€â”€ Hashtag cloud â”€â”€ */
  const topTags = countTop(d.hashtags, 40);
  if (topTags.length === 0) {
    document.getElementById('hashtagCloud').innerHTML = '<span style="color:#666;font-size:.85rem;">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù‡Ø§Ø´ØªØ§Ù‚Ø§Øª</span>';
  } else {
    const max = topTags[0][1];
    document.getElementById('hashtagCloud').innerHTML = topTags.map(([tag, cnt]) => {
      const ratio = cnt / max;
      const size = ratio > .7 ? 5 : ratio > .4 ? 4 : ratio > .2 ? 3 : ratio > .1 ? 2 : 1;
      return `<span class="an-tag size-${size}" title="${cnt} Ù…Ø±Ø©">${escHtml(tag)}</span>`;
    }).join('');
  }

  /* â”€â”€ Helper: render bar list â”€â”€ */
  function barList(containerId, entries, color = 'green', rtlLabel = false) {
    const el = document.getElementById(containerId);
    if (!entries.length) { el.innerHTML = '<span style="color:#666;font-size:.85rem;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§ÙÙŠØ©</span>'; return; }
    const max = entries[0][1];
    el.innerHTML = entries.map(([label, cnt]) => `
      <div class="an-bar-item">
        <div class="an-bar-label ${rtlLabel ? 'rtl' : ''}" title="${escHtml(label)}">${escHtml(label)}</div>
        <div class="an-bar-track">
          <div class="an-bar-fill ${color}" style="width:${Math.round(cnt / max * 100)}%"></div>
        </div>
        <div class="an-bar-count">${cnt}</div>
      </div>
    `).join('');
  }

  barList('domainBars',   countTop(d.domains, 10),    'blue');
  barList('cityBars',     countTop(d.cities,  10),    'orange', true);
  barList('skillBars',    countTop(d.skills,  12),    'purple');
  barList('contractBars', countTop(d.contracts, 5),   'teal',   true);
  barList('arabicKeyBars',countTop(d.arabicKeys, 12), 'green',  true);

  /* â”€â”€ Donut rings â”€â”€ */
  const donutData = [
    { label: 'Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©', sub: d.enJobs + ' ÙˆØ¸ÙŠÙØ©', pct: Math.round(d.enJobs / d.totalJobs * 100), color: '#3b82f6' },
    { label: 'Ø¹Ø±Ø¨ÙŠØ©',    sub: d.arJobs + ' ÙˆØ¸ÙŠÙØ©',  pct: Math.round(d.arJobs / d.totalJobs * 100), color: '#1dbf73' },
    { label: 'Ù…Ø¹ Ø±Ø§ØªØ¨',  sub: d.withSalary + ' ÙˆØ¸ÙŠÙØ©', pct: Math.round(d.withSalary / d.totalJobs * 100), color: '#f59e0b' },
    { label: 'Ø¹Ù† Ø¨Ø¹Ø¯',   sub: d.withRemote + ' ÙˆØ¸ÙŠÙØ©', pct: Math.round(d.withRemote / d.totalJobs * 100), color: '#8b5cf6' }
  ];

  document.getElementById('donutGrid').innerHTML = donutData.map(item => `
    <div class="an-donut-item">
      <div class="an-donut-ring" style="
        background: conic-gradient(${item.color} ${item.pct * 3.6}deg, rgba(255,255,255,.06) 0deg);
        box-shadow: 0 0 0 4px rgba(${item.color === '#1dbf73' ? '29,191,115' : '255,255,255'},.06);
      ">${item.pct}%</div>
      <div class="an-donut-label">${item.label}</div>
      <div class="an-donut-sub">${item.sub}</div>
    </div>
  `).join('');
}

/* Dark mode */
function initDarkMode() {
  if (localStorage.getItem('linkedoff_darkMode') === 'true') {
    document.body.classList.add('dark-mode');
    var btn = document.getElementById('darkModeBtn');
    if (btn) btn.textContent = 'â˜€ï¸';
  }
}
function toggleDarkMode() {
  var isDark = document.body.classList.toggle('dark-mode');
  localStorage.setItem('linkedoff_darkMode', isDark);
  var btn = document.getElementById('darkModeBtn');
  if (btn) btn.textContent = isDark ? 'â˜€ï¸' : 'ğŸŒ™';
}

document.addEventListener('DOMContentLoaded', initDarkMode);
</script>

<script>
  /* â”€â”€ Show user first name in topbar â”€â”€ */
  (function () {
    try {
      var user = JSON.parse(localStorage.getItem('linkedoff_user') || 'null');
      if (!user) return;
      var name = (user.name || user.email || '').split(' ')[0].split('@')[0];
      if (!name) return;
      var actions = document.querySelector('.topbar-actions');
      if (!actions) return;
      var chip = document.createElement('div');
      chip.id = 'topbarUserChip';
      chip.innerHTML = '<span class="avatar">ğŸ‘¤</span><span>' + name + '</span>';
      actions.insertBefore(chip, actions.firstChild);
    } catch (e) {}
  })();
</script>
    <script src="js/ui.js"></script>
</body>
</html>
