<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ø³Ø¬Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ - LinkedOFF</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/styles.css">
  <link rel="stylesheet" href="css/enhancements.css">
  <link rel="icon" type="image/svg+xml" href="img/icon-linkedoff.svg">

  <!-- â•â•â• EARLY AUTH GUARD â•â•â• -->
  <style>body { visibility: hidden; }</style>
  <script>
    (function () {
      try {
        var user = JSON.parse(localStorage.getItem('linkedoff_user') || 'null');
        var sess = JSON.parse(localStorage.getItem('linkedoff_session') || 'null');
        if (!user || !sess || !sess.token || Date.now() > Number(sess.expiresAtMs || 0)) {
          window.location.replace('login.html');
        } else {
          document.addEventListener('DOMContentLoaded', function () {
            document.body.style.visibility = 'visible';
          });
        }
      } catch (e) { window.location.replace('login.html'); }
    })();
  </script>
  <script src="js/auth.js"></script>
  <script src="js/config.js"></script>
  <script>startSessionEnforcer();</script>

  <style>
    /* â”€â”€ History Page â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .hs-wrapper { max-width: 1000px; margin: 0 auto; padding-bottom: 60px; }

    /* Hero */
    .hs-hero {
      background: linear-gradient(135deg, #0d1628 0%, #14102a 100%);
      border: 1px solid rgba(96,200,255,.18);
      border-radius: 20px;
      padding: 32px 36px;
      margin-bottom: 22px;
      position: relative;
      overflow: hidden;
    }

    .hs-hero::before {
      content: '';
      position: absolute;
      bottom: -60px; left: -60px;
      width: 200px; height: 200px;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(96,200,255,.1), transparent 70%);
      pointer-events: none;
    }

    .hs-hero h1 {
      font-size: 1.7rem;
      font-weight: 900;
      background: linear-gradient(90deg, #60c8ff, #c084fc);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 8px;
    }

    .hs-hero p { color: #8899aa; font-size: 0.9rem; margin: 0; }

    /* Stats row */
    .hs-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 14px;
      margin-bottom: 22px;
    }

    .hs-stat {
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 14px;
      padding: 18px 20px;
      text-align: center;
      animation: _cardIn .35s ease both;
    }

    .hs-stat .hs-stat-num {
      font-size: 1.9rem;
      font-weight: 900;
      line-height: 1;
      margin-bottom: 5px;
    }

    .hs-stat .hs-stat-lbl {
      font-size: 0.78rem;
      color: #8899aa;
      font-family: 'Cairo', sans-serif;
    }

    .hs-stat-num.blue { color: #60c8ff; }
    .hs-stat-num.purple { color: #c084fc; }
    .hs-stat-num.green { color: #1dbf73; }
    .hs-stat-num.orange { color: #f59e0b; }

    /* Toolbar */
    .hs-toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }

    .hs-toolbar-info { font-size: 0.85rem; color: #8899aa; font-family: 'Cairo', sans-serif; }

    .hs-btn {
      display: inline-flex;
      align-items: center;
      gap: 7px;
      padding: 8px 18px;
      border-radius: 10px;
      font-family: 'Cairo', sans-serif;
      font-size: 0.85rem;
      font-weight: 700;
      cursor: pointer;
      border: none;
      transition: transform .15s, box-shadow .15s;
      text-decoration: none;
    }

    .hs-btn-primary {
      background: linear-gradient(135deg, #60c8ff, #c084fc);
      color: #0a0a1a;
      box-shadow: 0 3px 12px rgba(96,200,255,.3);
    }

    .hs-btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(96,200,255,.4); }

    .hs-btn-danger {
      background: rgba(239,68,68,.1);
      color: #ef4444;
      border: 1px solid rgba(239,68,68,.3) !important;
    }

    .hs-btn-danger:hover { background: rgba(239,68,68,.18); }

    /* Search/filter bar */
    .hs-filter-bar {
      display: flex;
      gap: 10px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .hs-filter-bar input {
      flex: 1;
      min-width: 200px;
      background: rgba(255,255,255,.07);
      border: 1px solid rgba(255,255,255,.12);
      color: #f0f0f0;
      border-radius: 10px;
      padding: 9px 14px;
      font-family: 'Cairo', sans-serif;
      font-size: 0.88rem;
    }

    .hs-filter-bar input:focus {
      outline: none;
      border-color: rgba(96,200,255,.4);
      box-shadow: 0 0 0 3px rgba(96,200,255,.1);
    }

    .hs-filter-bar select {
      background: rgba(255,255,255,.07);
      border: 1px solid rgba(255,255,255,.12);
      color: #f0f0f0;
      border-radius: 10px;
      padding: 9px 14px;
      font-family: 'Cairo', sans-serif;
      font-size: 0.85rem;
      cursor: pointer;
    }

    /* Table */
    .hs-table-wrap {
      background: rgba(255,255,255,.03);
      border: 1px solid rgba(255,255,255,.07);
      border-radius: 16px;
      overflow: hidden;
    }

    .hs-table {
      width: 100%;
      border-collapse: collapse;
      font-family: 'Cairo', sans-serif;
    }

    .hs-table thead tr {
      background: rgba(96,200,255,.07);
      border-bottom: 1px solid rgba(255,255,255,.07);
    }

    .hs-table thead th {
      padding: 14px 16px;
      font-size: 0.82rem;
      font-weight: 900;
      color: #8899aa;
      text-align: right;
      white-space: nowrap;
    }

    .hs-table tbody tr {
      border-bottom: 1px solid rgba(255,255,255,.04);
      transition: background .15s;
    }

    .hs-table tbody tr:last-child { border-bottom: none; }
    .hs-table tbody tr:hover { background: rgba(96,200,255,.04); }

    .hs-table tbody td {
      padding: 12px 16px;
      font-size: 0.85rem;
      color: #d0d0e0;
      vertical-align: middle;
    }

    .hs-email {
      font-family: monospace;
      font-size: 0.82rem;
      color: #60c8ff;
      word-break: break-all;
    }

    .hs-email a {
      color: inherit;
      text-decoration: none;
    }

    .hs-email a:hover { text-decoration: underline; }

    .hs-count-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 26px;
      height: 22px;
      padding: 0 8px;
      border-radius: 999px;
      font-size: 0.78rem;
      font-weight: 900;
    }

    .hs-count-badge.once { background: rgba(29,191,115,.15); color: #1dbf73; border: 1px solid rgba(29,191,115,.25); }
    .hs-count-badge.few  { background: rgba(245,158,11,.15); color: #f59e0b; border: 1px solid rgba(245,158,11,.25); }
    .hs-count-badge.many { background: rgba(239,68,68,.15); color: #ef4444; border: 1px solid rgba(239,68,68,.25); }

    .hs-date { font-size: 0.8rem; color: #8899aa; white-space: nowrap; }
    .hs-date .hs-date-first { color: #6688bb; font-size: 0.75rem; }

    .hs-resend-btn {
      padding: 5px 12px;
      border-radius: 7px;
      font-family: 'Cairo', sans-serif;
      font-size: 0.78rem;
      font-weight: 700;
      cursor: pointer;
      background: rgba(96,200,255,.1);
      border: 1px solid rgba(96,200,255,.25);
      color: #60c8ff;
      transition: all .15s;
      white-space: nowrap;
    }

    .hs-resend-btn:hover { background: rgba(96,200,255,.2); }

    .hs-remove-btn {
      padding: 5px 10px;
      border-radius: 7px;
      font-family: 'Cairo', sans-serif;
      font-size: 0.78rem;
      font-weight: 700;
      cursor: pointer;
      background: rgba(239,68,68,.08);
      border: 1px solid rgba(239,68,68,.2);
      color: #ef4444;
      transition: all .15s;
    }

    .hs-remove-btn:hover { background: rgba(239,68,68,.16); }

    /* Empty state */
    .hs-empty {
      text-align: center;
      padding: 64px 32px;
      border: 2px dashed rgba(255,255,255,.08);
      border-radius: 16px;
    }

    .hs-empty .hs-empty-icon { font-size: 3.5rem; margin-bottom: 14px; opacity: .5; }
    .hs-empty h3 { font-size: 1.1rem; color: #8899aa; margin-bottom: 10px; }
    .hs-empty p { font-size: 0.88rem; color: #556; margin-bottom: 22px; }

    /* Chart bar */
    .hs-mini-bar {
      display: inline-block;
      height: 6px;
      border-radius: 3px;
      background: linear-gradient(90deg, #60c8ff, #c084fc);
      vertical-align: middle;
      margin-right: 6px;
    }

    /* Pagination */
    .hs-pagination {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-top: 20px;
      flex-wrap: wrap;
    }

    .hs-page-btn {
      padding: 7px 14px;
      border-radius: 8px;
      font-family: 'Cairo', sans-serif;
      font-size: 0.8rem;
      font-weight: 700;
      cursor: pointer;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.1);
      color: #ccc;
      transition: all .15s;
    }

    .hs-page-btn:hover { background: rgba(96,200,255,.1); border-color: rgba(96,200,255,.3); color: #60c8ff; }
    .hs-page-btn.active { background: rgba(96,200,255,.15); border-color: rgba(96,200,255,.35); color: #60c8ff; }

    /* Section: domain breakdown */
    .hs-domains {
      background: rgba(255,255,255,.03);
      border: 1px solid rgba(255,255,255,.07);
      border-radius: 16px;
      padding: 20px 24px;
      margin-top: 20px;
      animation: _cardIn .35s ease both;
    }

    .hs-domains-title {
      font-size: 0.95rem;
      font-weight: 900;
      color: #c0c0d0;
      margin-bottom: 16px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(255,255,255,.06);
    }

    .hs-domain-list { display: flex; flex-direction: column; gap: 9px; }

    .hs-domain-row {
      display: grid;
      grid-template-columns: 180px 1fr 40px;
      align-items: center;
      gap: 10px;
      font-size: 0.82rem;
    }

    .hs-domain-name { color: #8899bb; font-family: monospace; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    .hs-domain-bar-bg { background: rgba(255,255,255,.06); border-radius: 4px; height: 8px; overflow: hidden; }
    .hs-domain-bar-fill { height: 100%; border-radius: 4px; background: linear-gradient(90deg, #60c8ff, #c084fc); transition: width .5s ease; }

    .hs-domain-count { color: #8899aa; font-size: 0.78rem; text-align: left; }

    /* â”€â”€ Activity chart (last 30 days) â”€â”€ */
    .hs-activity {
      background: rgba(255,255,255,.03);
      border: 1px solid rgba(255,255,255,.07);
      border-radius: 16px;
      padding: 20px 24px;
      margin-top: 20px;
      animation: _cardIn .35s ease both;
    }

    .hs-activity-title {
      font-size: 0.95rem;
      font-weight: 900;
      color: #c0c0d0;
      margin-bottom: 16px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(255,255,255,.06);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 8px;
    }

    .hs-csv-btn {
      padding: 6px 14px;
      border-radius: 8px;
      font-family: 'Cairo', sans-serif;
      font-size: 0.78rem;
      font-weight: 700;
      cursor: pointer;
      background: rgba(29,191,115,.1);
      border: 1px solid rgba(29,191,115,.25);
      color: #1dbf73;
      transition: all .15s;
    }

    .hs-csv-btn:hover { background: rgba(29,191,115,.2); }

    .hs-chart {
      display: flex;
      align-items: flex-end;
      gap: 4px;
      height: 70px;
      overflow-x: auto;
      padding-bottom: 4px;
    }

    .hs-chart-col {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 3px;
      min-width: 18px;
      flex: 1;
    }

    .hs-chart-bar {
      width: 100%;
      border-radius: 3px 3px 0 0;
      background: linear-gradient(180deg, #60c8ff, #c084fc);
      min-height: 3px;
      transition: opacity .2s;
      cursor: default;
    }

    .hs-chart-bar:hover { opacity: .75; }

    .hs-chart-label {
      font-size: 9px;
      color: #556;
      white-space: nowrap;
      font-family: monospace;
    }

    .hs-chart-zero { opacity: .25; }
  </style>
</head>

<body class="app-page" data-page="history">
<div class="app-shell">
  <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar(false)"></div>

  <!-- â”€â”€â”€ Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <aside class="app-sidebar" id="appSidebar" aria-label="Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ©">
    <div class="sidebar-brand">
      <a href="index.html" class="brand-link">
        <span class="brand-mark">ğŸ’¼</span>
        <span class="brand-text">LinkedOFF</span>
        <span class="brand-sub">AceAlBastoni</span>
      </a>
    </div>

    <nav class="sidebar-nav">
      <a href="search.html"              class="nav-item"><span class="nav-ic">ğŸ </span><span>Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</span></a>
      <a href="search.html"              class="nav-item"><span class="nav-ic">ğŸ”</span><span>Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„ÙˆØ¸Ø§Ø¦Ù</span></a>
      <a href="dashboard.html"           class="nav-item"><span class="nav-ic">ğŸ“Š</span><span>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</span></a>
      <a href="analytics.html"           class="nav-item"><span class="nav-ic">ğŸ“ˆ</span><span>ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„Ø³ÙˆÙ‚</span></a>
      <a href="saved.html"               class="nav-item"><span class="nav-ic">ğŸ’¾</span><span>Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©</span></a>
      <a href="history.html"             class="nav-item active"><span class="nav-ic">ğŸ“¬</span><span>Ø³Ø¬Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</span></a>
      <a href="engines-interactive.html" class="nav-item"><span class="nav-ic">âš™ï¸</span><span>Ø§Ù„Ù…Ø­Ø±ÙƒØ§Øª</span></a>
      <a href="about.html"               class="nav-item"><span class="nav-ic">ğŸ‘¤</span><span>Ø¹Ù† Ø§Ù„Ù…Ø·ÙˆÙ‘Ø±</span></a>
      <a href="pricing.html"             class="nav-item"><span class="nav-ic">ğŸ’³</span><span>Ø§Ù„Ø¨Ø§Ù‚Ø§Øª</span></a>
      <a href="settings.html"            class="nav-item"><span class="nav-ic">ğŸ”§</span><span>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span></a>
    </nav>

    <div class="sidebar-footer">
      <button class="sidebar-logout" type="button" onclick="performLogout('ğŸ‘‹ ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬', false)">
        <span class="nav-ic">ğŸšª</span><span>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</span>
      </button>
    </div>
  </aside>

  <!-- â”€â”€â”€ Main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="app-main">
    <header class="app-topbar">
      <button class="sidebar-toggle" type="button" aria-label="ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©" onclick="toggleSidebar()">
        <span class="toggle-bars"></span>
      </button>
      <div class="topbar-title">ğŸ“¬ Ø³Ø¬Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</div>
      <div class="topbar-actions">
        <button id="darkModeBtn" onclick="toggleDarkMode()" title="ÙˆØ¶Ø¹ Ù„ÙŠÙ„ÙŠ" style="
          background:none;border:1px solid #ddd;border-radius:8px;
          padding:6px 10px;cursor:pointer;font-size:18px;line-height:1;
          transition:background .2s,border-color .2s;
        ">ğŸŒ™</button>
      </div>
    </header>

    <main class="app-content" style="padding:24px 20px;">
      <div class="hs-wrapper">

        <!-- Hero -->
        <div class="hs-hero">
          <h1>ğŸ“¬ Ø³Ø¬Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø³ÙŠØ± Ø§Ù„Ø°Ø§ØªÙŠØ©</h1>
          <p>ØªØ§Ø±ÙŠØ® ÙƒØ§Ù…Ù„ Ù„ÙƒÙ„ Ø´Ø±ÙƒØ© Ø£Ø±Ø³Ù„Øª Ø¥Ù„ÙŠÙ‡Ø§ Ø³ÙŠØ±ØªÙƒ Ø§Ù„Ø°Ø§ØªÙŠØ©ØŒ Ù…Ø¹ Ø¹Ø¯Ø¯ Ù…Ø±Ø§Øª Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§Ù„ØªÙˆØ§Ø±ÙŠØ®.</p>
        </div>

        <!-- Stats -->
        <div class="hs-stats" id="hsStats">
          <div class="hs-stat" style="animation-delay:.05s">
            <div class="hs-stat-num blue" id="statUnique">0</div>
            <div class="hs-stat-lbl">Ø´Ø±ÙƒØ© ÙØ±ÙŠØ¯Ø©</div>
          </div>
          <div class="hs-stat" style="animation-delay:.1s">
            <div class="hs-stat-num green" id="statTotal">0</div>
            <div class="hs-stat-lbl">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„Ø§Øª</div>
          </div>
          <div class="hs-stat" style="animation-delay:.15s">
            <div class="hs-stat-num orange" id="statToday">0</div>
            <div class="hs-stat-lbl">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙŠÙˆÙ…</div>
          </div>
          <div class="hs-stat" style="animation-delay:.2s">
            <div class="hs-stat-num purple" id="statMax">0</div>
            <div class="hs-stat-lbl">Ø£ÙƒØ«Ø± Ø¥Ø±Ø³Ø§Ù„ Ù„Ø´Ø±ÙƒØ©</div>
          </div>
        </div>

        <!-- Filter bar -->
        <div class="hs-filter-bar">
          <input type="text" id="hsSearch" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø£Ùˆ Ø§Ù„Ø¯ÙˆÙ…ÙŠÙ†..." oninput="filterAndRender()">
          <select id="hsSort" onchange="filterAndRender()">
            <option value="recent">Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹</option>
            <option value="oldest">Ø§Ù„Ø£Ù‚Ø¯Ù… Ø£ÙˆÙ„Ø§Ù‹</option>
            <option value="most">Ø§Ù„Ø£ÙƒØ«Ø± Ø¥Ø±Ø³Ø§Ù„Ø§Ù‹</option>
            <option value="az">ØªØ±ØªÙŠØ¨ Ø£Ø¨Ø¬Ø¯ÙŠ</option>
          </select>
        </div>

        <!-- Toolbar -->
        <div class="hs-toolbar">
          <div class="hs-toolbar-info" id="hsRangeInfo">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„</div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <a href="search.html" class="hs-btn hs-btn-primary">ğŸ” Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø¨Ø­Ø«</a>
            <button class="hs-btn hs-btn-danger" onclick="clearAllHistory()">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„</button>
          </div>
        </div>

        <!-- Table -->
        <div id="hsTableContainer"></div>

        <!-- Pagination -->
        <div class="hs-pagination" id="hsPagination"></div>

        <!-- Domain breakdown -->
        <div class="hs-domains" id="hsDomains" style="display:none;">
          <div class="hs-domains-title">ğŸ“Š ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø­Ø³Ø¨ Ø§Ù„Ø¯ÙˆÙ…ÙŠÙ†</div>
          <div class="hs-domain-list" id="hsDomainList"></div>
        </div>

        <!-- Activity chart -->
        <div class="hs-activity" id="hsActivity" style="display:none;">
          <div class="hs-activity-title">
            <span>ğŸ“… Ù†Ø´Ø§Ø· Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ â€” Ø¢Ø®Ø± 30 ÙŠÙˆÙ…</span>
            <button class="hs-csv-btn" onclick="exportCSV()">â¬‡ï¸ ØªØµØ¯ÙŠØ± CSV</button>
          </div>
          <div class="hs-chart" id="hsChart"></div>
        </div>

      </div>
    </main>
  </div>
</div>
<script>
  var PAGE_SIZE = 25;
  var currentPage = 1;
  var filteredData = [];

  /* â”€â”€ Data helpers â”€â”€ */
  function getHistory() {
    try { return JSON.parse(localStorage.getItem('appliedJobs') || '{}'); } catch { return {}; }
  }

  function getDailyData() {
    try { return JSON.parse(localStorage.getItem('dailySends') || '{}'); } catch { return {}; }
  }

  function getDomain(email) {
    var parts = String(email).split('@');
    return parts.length === 2 ? parts[1].toLowerCase() : email;
  }

  /* â”€â”€ Stats â”€â”€ */
  function computeStats(data) {
    var emails = Object.keys(data);
    var today  = new Date().toISOString().slice(0, 10);
    var total  = 0;
    var todayCt = 0;
    var maxCt = 0;

    emails.forEach(function(em) {
      var rec = data[em];
      total += (rec.count || 1);
      if (rec.lastSent === today) todayCt += (rec.count || 1);
      if ((rec.count || 1) > maxCt) maxCt = (rec.count || 1);
    });

    return { unique: emails.length, total: total, today: todayCt, max: maxCt };
  }

  /* â”€â”€ Filter + Sort â”€â”€ */
  function filterAndRender() {
    var query = (document.getElementById('hsSearch').value || '').toLowerCase().trim();
    var sort  = document.getElementById('hsSort').value;
    var data  = getHistory();

    var entries = Object.keys(data).map(function(em) {
      return Object.assign({ email: em }, data[em]);
    });

    if (query) {
      entries = entries.filter(function(e) {
        return e.email.toLowerCase().indexOf(query) !== -1;
      });
    }

    if (sort === 'recent') {
      entries.sort(function(a, b) { return (b.lastSent || '').localeCompare(a.lastSent || ''); });
    } else if (sort === 'oldest') {
      entries.sort(function(a, b) { return (a.firstSent || '').localeCompare(b.firstSent || ''); });
    } else if (sort === 'most') {
      entries.sort(function(a, b) { return (b.count || 1) - (a.count || 1); });
    } else if (sort === 'az') {
      entries.sort(function(a, b) { return a.email.localeCompare(b.email); });
    }

    filteredData = entries;
    currentPage = 1;
    renderTable();
    renderDomains(data);
    renderActivityChart();
  }

  /* â”€â”€ Table rendering â”€â”€ */
  function renderTable() {
    var container = document.getElementById('hsTableContainer');
    var pagination = document.getElementById('hsPagination');
    var rangeInfo  = document.getElementById('hsRangeInfo');
    var data = getHistory();

    /* Stats always from full data */
    var stats = computeStats(data);
    document.getElementById('statUnique').textContent = stats.unique;
    document.getElementById('statTotal').textContent  = stats.total;
    document.getElementById('statToday').textContent  = stats.today;
    document.getElementById('statMax').textContent    = stats.max;

    if (filteredData.length === 0) {
      var isEmpty = Object.keys(data).length === 0;
      container.innerHTML = isEmpty
        ? `<div class="hs-empty">
            <div class="hs-empty-icon">ğŸ“¬</div>
            <h3>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø¹Ø¯</h3>
            <p>Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø±Ø³Ø§Ù„ Ø³ÙŠØ±ØªÙƒ Ø§Ù„Ø°Ø§ØªÙŠØ© Ù…Ù† ØµÙØ­Ø© Ø§Ù„Ø¨Ø­Ø« ÙˆØ³ØªØ¸Ù‡Ø± Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ù‡Ù†Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.</p>
            <a href="search.html" class="hs-btn hs-btn-primary" style="display:inline-flex;text-decoration:none;">ğŸ” Ø§Ù„Ø°Ù‡Ø§Ø¨ Ù„Ù„Ø¨Ø­Ø«</a>
          </div>`
        : `<div class="hs-empty">
            <div class="hs-empty-icon">ğŸ”</div>
            <h3>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù„Ù„Ø¨Ø­Ø«</h3>
            <p>Ø¬Ø±Ù‘Ø¨ ÙƒÙ„Ù…Ø© Ø¨Ø­Ø« Ù…Ø®ØªÙ„ÙØ©.</p>
          </div>`;
      pagination.innerHTML = '';
      rangeInfo.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬';
      return;
    }

    var total = filteredData.length;
    var totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
    currentPage = Math.max(1, Math.min(currentPage, totalPages));

    var start = (currentPage - 1) * PAGE_SIZE;
    var end   = Math.min(start + PAGE_SIZE, total);
    var slice = filteredData.slice(start, end);

    rangeInfo.textContent = 'Ø¹Ø±Ø¶ ' + (start + 1) + ' â€“ ' + end + ' Ù…Ù† Ø£ØµÙ„ ' + total + ' Ø³Ø¬Ù„';

    var maxCount = filteredData.reduce(function(m, e) { return Math.max(m, e.count || 1); }, 1);

    var rows = slice.map(function(entry, i) {
      var count = entry.count || 1;
      var countClass = count === 1 ? 'once' : (count <= 3 ? 'few' : 'many');
      var barW = Math.round((count / maxCount) * 100);

      return `<tr>
        <td>
          <div class="hs-email">
            <a href="mailto:${escHtml(entry.email)}">${escHtml(entry.email)}</a>
          </div>
          <div style="margin-top:4px;">
            <span class="hs-mini-bar" style="width:${barW}px;max-width:80px;"></span>
          </div>
        </td>
        <td>
          <span class="hs-count-badge ${countClass}">${count}Ã—</span>
        </td>
        <td>
          <div class="hs-date">${entry.lastSent || 'â€”'}</div>
          ${entry.firstSent && entry.firstSent !== entry.lastSent
            ? `<div class="hs-date hs-date-first">Ø£ÙˆÙ„ Ø¥Ø±Ø³Ø§Ù„: ${entry.firstSent}</div>`
            : ''}
        </td>
        <td>
          <button class="hs-resend-btn" onclick="resendTo('${escHtml(entry.email)}')">ğŸ“¤ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</button>
        </td>
        <td>
          <button class="hs-remove-btn" onclick="removeEntry('${escHtml(entry.email)}')">ğŸ—‘ï¸</button>
        </td>
      </tr>`;
    });

    container.innerHTML = `
      <div class="hs-table-wrap">
        <table class="hs-table">
          <thead>
            <tr>
              <th>ğŸ“§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</th>
              <th>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø§Øª</th>
              <th>ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
              <th>Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</th>
              <th></th>
            </tr>
          </thead>
          <tbody>${rows.join('')}</tbody>
        </table>
      </div>`;

    /* Pagination */
    if (totalPages <= 1) {
      pagination.innerHTML = '';
      return;
    }

    var pages = [];
    var lo = Math.max(1, currentPage - 2);
    var hi = Math.min(totalPages, currentPage + 2);
    for (var p = lo; p <= hi; p++) {
      pages.push('<button class="hs-page-btn' + (p === currentPage ? ' active' : '') +
        '" onclick="goPage(' + p + ')">' + p + '</button>');
    }

    pagination.innerHTML =
      (currentPage > 1 ? '<button class="hs-page-btn" onclick="goPage(1)">â®</button><button class="hs-page-btn" onclick="goPage(' + (currentPage - 1) + ')">â†’</button>' : '') +
      pages.join('') +
      (currentPage < totalPages ? '<button class="hs-page-btn" onclick="goPage(' + (currentPage + 1) + ')">â†</button><button class="hs-page-btn" onclick="goPage(' + totalPages + ')">â­</button>' : '');
  }

  /* â”€â”€ Domain breakdown â”€â”€ */
  function renderDomains(data) {
    var domainMap = {};
    Object.keys(data).forEach(function(em) {
      var d = getDomain(em);
      domainMap[d] = (domainMap[d] || 0) + (data[em].count || 1);
    });

    var sorted = Object.keys(domainMap).sort(function(a, b) { return domainMap[b] - domainMap[a]; }).slice(0, 12);
    if (sorted.length === 0) {
      document.getElementById('hsDomains').style.display = 'none';
      return;
    }

    document.getElementById('hsDomains').style.display = 'block';
    var max = domainMap[sorted[0]];

    document.getElementById('hsDomainList').innerHTML = sorted.map(function(d) {
      var w = Math.round((domainMap[d] / max) * 100);
      return `<div class="hs-domain-row">
        <div class="hs-domain-name" title="${escHtml(d)}">${escHtml(d)}</div>
        <div class="hs-domain-bar-bg"><div class="hs-domain-bar-fill" style="width:${w}%"></div></div>
        <div class="hs-domain-count">${domainMap[d]}</div>
      </div>`;
    }).join('');
  }

  /* â”€â”€ Activity Chart (last 30 days) â”€â”€ */
  function renderActivityChart() {
    var dailyData = getDailyData();
    var keys = Object.keys(dailyData);
    if (keys.length === 0) {
      document.getElementById('hsActivity').style.display = 'none';
      return;
    }
    document.getElementById('hsActivity').style.display = 'block';

    /* Build last 30 days array */
    var days = [];
    for (var i = 29; i >= 0; i--) {
      var d = new Date();
      d.setDate(d.getDate() - i);
      var key = d.toISOString().slice(0, 10);
      days.push({ key: key, label: (d.getDate()) + '/' + (d.getMonth() + 1), count: dailyData[key] || 0 });
    }

    var max = days.reduce(function(m, d) { return Math.max(m, d.count); }, 1);

    document.getElementById('hsChart').innerHTML = days.map(function(d) {
      var h = Math.round((d.count / max) * 60);
      var zero = d.count === 0;
      return '<div class="hs-chart-col" title="' + d.key + ': ' + d.count + ' Ø¥Ø±Ø³Ø§Ù„">' +
        '<div class="hs-chart-bar' + (zero ? ' hs-chart-zero' : '') + '" style="height:' + Math.max(h, 3) + 'px"></div>' +
        '<div class="hs-chart-label">' + d.label + '</div>' +
        '</div>';
    }).join('');
  }

  /* â”€â”€ CSV Export â”€â”€ */
  function exportCSV() {
    var data = getHistory();
    var rows = [['Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ', 'Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„Ø§Øª', 'Ø£ÙˆÙ„ Ø¥Ø±Ø³Ø§Ù„', 'Ø¢Ø®Ø± Ø¥Ø±Ø³Ø§Ù„']];
    Object.keys(data).forEach(function(em) {
      var r = data[em];
      rows.push([em, r.count || 1, r.firstSent || '', r.lastSent || '']);
    });
    var csv = rows.map(function(r) {
      return r.map(function(v) { return '"' + String(v).replace(/"/g, '""') + '"'; }).join(',');
    }).join('\n');

    var blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
    var url  = URL.createObjectURL(blob);
    var a    = document.createElement('a');
    a.href     = url;
    a.download = 'linkedoff-history-' + new Date().toISOString().slice(0, 10) + '.csv';
    a.click();
    URL.revokeObjectURL(url);
  }

  /* â”€â”€ Actions â”€â”€ */
  function resendTo(email) {
    var subject = 'Ø·Ù„Ø¨ ØªÙˆØ¸ÙŠÙ';
    var body    = 'Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ\n\nØ£Ù†Ø§ Ù…Ù‡ØªÙ… Ø¨Ø§Ù„ØªÙ‚Ø¯ÙŠÙ… Ø¹Ù„Ù‰ Ø¥Ø­Ø¯Ù‰ Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…ØªØ§Ø­Ø© Ù„Ø¯ÙŠÙƒÙ….\n\nØ´ÙƒØ±Ø§Ù‹';
    window.location.href = 'mailto:' + email + '?subject=' + encodeURIComponent(subject) + '&body=' + encodeURIComponent(body);
  }

  function removeEntry(email) {
    var data = getHistory();
    delete data[email];
    localStorage.setItem('appliedJobs', JSON.stringify(data));
    filterAndRender();
  }

  function clearAllHistory() {
    if (!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ Ø³Ø¬Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.')) return;
    localStorage.setItem('appliedJobs', '{}');
    filterAndRender();
  }

  function goPage(p) {
    currentPage = p;
    renderTable();
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  /* â”€â”€ Helpers â”€â”€ */
  function escHtml(s) {
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }

  /* â”€â”€ Dark mode â”€â”€ */
  function initDarkMode() {
    if (localStorage.getItem('linkedoff_darkMode') === 'true') {
      document.body.classList.add('dark-mode');
      var btn = document.getElementById('darkModeBtn');
      if (btn) btn.textContent = 'â˜€ï¸';
    }
  }

  function toggleDarkMode() {
    var isDark = document.body.classList.toggle('dark-mode');
    localStorage.setItem('linkedoff_darkMode', isDark);
    var btn = document.getElementById('darkModeBtn');
    if (btn) btn.textContent = isDark ? 'â˜€ï¸' : 'ğŸŒ™';
  }

  /* â”€â”€ User chip â”€â”€ */
  function injectUserChip() {
    try {
      var user = JSON.parse(localStorage.getItem('linkedoff_user') || 'null');
      if (!user) return;
      var name    = user.name || user.email || '';
      var initial = name.trim().charAt(0).toUpperCase() || '?';
      var actions = document.querySelector('.topbar-actions');
      if (!actions) return;
      var chip = document.createElement('div');
      chip.id = 'topbarUserChip';
      chip.innerHTML = '<span class="avatar">' + initial + '</span><span>' + name + '</span>';
      actions.insertBefore(chip, actions.firstChild);
    } catch(e) {}
  }

  document.addEventListener('DOMContentLoaded', function() {
    initDarkMode();
    injectUserChip();
    filterAndRender();
  });
</script>
    <script src="js/ui.js"></script>
</body>
</html>
